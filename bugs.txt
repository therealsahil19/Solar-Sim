EASY

Description
A new `THREE.RingGeometry` is created for every ring, leading to redundant geometry data and initialization overhead.

Location
src/procedural.ts:424

Rationale
Caching geometries based on parameters (inner/outer radius) would significantly reduce memory usage and setup time.

Code context
    const inner = ringData.inner ?? 1.4;
    const outer = ringData.outer ?? 2.2;
    const ringGeo = new THREE.RingGeometry(inner, outer, 128);

    const pos = ringGeo.attributes.position as THREE.BufferAttribute;
    const uv = ringGeo.attributes.uv as THREE.BufferAttribute;

Description
The `filter` method runs on every input event, re-filtering and re-sorting the entire list of items.

Location
src/components/CommandPalette.ts:273

Rationale
Debouncing the input event handler would prevent excessive computations and DOM updates while typing, improving responsiveness.

Code context
    private filter(query: string): void {
        const q = query.toLowerCase().trim();

        if (!q) {
            this.filteredItems = this.items;
        } else {
            this.filteredItems = this.items.filter(item =>
                (item.name?.toLowerCase() ?? '').includes(q) ||
                (item.type?.toLowerCase() ?? '').includes(q)
            );

Description
The helper function `getGridIndex` is defined inside the `runCollisionDetection` method, causing function reallocation every time it is called (potentially every frame).

Location
src/managers/LabelManager.ts:214

Rationale
The fix is trivial: move the helper function outside the method or make it a class method. It avoids unnecessary function object creation in a hot loop.

Code context
        const getGridIndex = (c: number, r: number) => {
            if (c < 0 || c >= this.labelGridCols || r < 0 || r >= this.labelGridRows) return -1;
            return r * this.labelGridCols + c;
        };

        for (const item of this.visibleLabelsList) {
            const startCol = Math.floor(item.x / cellWidth);

Description
The CSP allows `style-src 'unsafe-inline'`, which weakens defenses against Cross-Site Scripting (XSS) attacks by allowing arbitrary inline styles.

Location
index.html:9

Rationale
The CSP string explicitly includes `'unsafe-inline'` for `style-src`.

Code context
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data:; connect-src 'self' https://unpkg.com; font-src 'self'; worker-src 'self' blob:;">

Description
InstanceRegistry.build() disposes geometry on rebuild, which breaks shared geometries like `baseSphereGeometry`.

Location
src/instancing.ts:118

Rationale
Clear bug. Geometry is shared and should not be disposed by the registry unless ownership is clear.

Code context
        this.groups.forEach((group, key) => {
            if (group.mesh) {
                this.scene.remove(group.mesh);
                group.mesh.geometry?.dispose();
                const material = group.mesh.material;
                if (Array.isArray(material)) {

Description
Leftover `console.log` used for debugging lazy loading should be removed.

Location
src/main.ts:370

Rationale
Debug code is not needed in production.

Code context
    if (textureLoader.lazyLoadQueue && textureLoader.lazyLoadQueue.length > 0) {
        setTimeout(() => {
            if (initFailed || !textureLoader.lazyLoadQueue) return;
            console.log(`Bolt ⚡: Lazy loading ${textureLoader.lazyLoadQueue.length} textures...`);
            textureLoader.lazyLoadQueue.forEach(item => {
                const tex = textureLoader.load(item.url);

Description
Commented-out code `// const allLabels...` should be removed to reduce clutter.

Location
src/main.ts:68

Rationale
Simple cleanup. No risk.

Code context
const allOrbits: THREE.LineLoop[] = [];
const allTrails: unknown[] = [];
// const allLabels: CSS2DObject[] = []; // Managed by LabelManager

let playerShip: THREE.Group | null = null;

Description
The Content Security Policy in `index.html` allows scripts and connections to `https://unpkg.com`, but the application does not load any external scripts from unpkg, unnecessarily increasing the attack surface.

Location
index.html:9

Rationale
Search confirms `unpkg` is not used in `src/` or `index.html` body, making the allowance unnecessary.

Code context
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Solar System</title>

    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data:; connect-src 'self' https://unpkg.com; font-src 'self'; worker-src 'self' blob:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">

Description
The ternary operator `parentData ? null : null` always evaluates to null, making the parameter useless.

Location
src/procedural.ts:483

Rationale
Clear logic error. Likely intended to assign parentData.

Code context
    const label = new CSS2DObject(labelDiv);
    label.position.set(0, data.visual.size + 1.0, 0);
    label.userData.isMoon = (data.type === 'Moon');
    label.userData.parentPlanet = parentData ? null : null;
    return label;

Description
Casting `matrixWorld.elements` to `any` is unnecessary as `number[]` supports index access.

Location
src/utils/ThreeUtils.ts:11

Rationale
Improves type safety.

Code context
export function getPositionFromMatrix(object: THREE.Object3D, target: THREE.Vector3): void {
    const te = object.matrixWorld.elements as any;
    target.set(te[12], te[13], te[14]);
}

Description
The `download_textures.py` script downloads images from `solarsystemscope.com` without verifying their SHA-256 checksums, which could allow a compromised server or MITM attack to inject malicious content.

Location
download_textures.py:42

Rationale
The script clearly downloads files and saves them without any verification step.

Code context
    try:
        # Verify SSL certificates properly using reused context
        with urllib.request.urlopen(url, context=context) as response, open(filepath, 'wb') as out_file:
            shutil.copyfileobj(response, out_file)
        print(f"  - Downloading {filename}... ✅ Done.")
        return None
    except Exception as e:

Description
The CommandPalette component handles search filtering, but lacks a specific test case to verify that the "No results found" message is displayed when appropriate.

Location
src/components/CommandPalette.ts:302

Rationale
Extending the existing CommandPalette.test.ts to include a search query that yields no results is a simple and high-confidence addition.

Code context
        if (this.filteredItems.length === 0) {
            const empty = document.createElement('li');
            empty.className = 'cmd-empty';
            empty.textContent = 'No results found.';
            this.list.appendChild(empty);

Description
The InfoPanel component displays details for selected celestial objects but lacks unit tests to verify data binding and visibility logic.

Location
src/components/InfoPanel.ts:38

Rationale
Testing this component involves verifying DOM updates based on input data, which is simple to achieve in a jsdom environment.

Code context
export class InfoPanel implements Disposable {
    private callbacks: InfoPanelCallbacks;
    private currentMesh: THREE.Object3D | null = null;
    private dom: InfoPanelDOM;
    private _handleFollowClick: ((e: MouseEvent) => void) | null = null;

Description
The ToastManager singleton handles UI notifications but has no unit tests to verify its behavior.

Location
src/managers/ToastManager.ts:13

Rationale
The class is self-contained and interacts primarily with the DOM, making it straightforward to test using jsdom and standard mocking techniques.

Code context
export class ToastManager {
    private container: HTMLElement;
    private static instance: ToastManager;

    private constructor() {
        this.container = document.getElementById('toast-container') as HTMLElement;

Description
The src/utils/ThreeUtils.ts file contains untested utility functions like getPositionFromMatrix for optimization.

Location
src/utils/ThreeUtils.ts:10

Rationale
This is a pure utility function that performs matrix math. It is trivial to test using Three.js vector and matrix mocks.

Code context
export function getPositionFromMatrix(object: THREE.Object3D, target: THREE.Vector3): void {
    const te = object.matrixWorld.elements as any;
    target.set(te[12], te[13], te[14]);
}

MEDIUM

Description
Collision detection uses nested loops inside a loop, leading to potential performance degradation with many labels.

Location
src/managers/LabelManager.ts:226

Rationale
While spatial hashing is used, the implementation iterates over neighbors inefficiently. Optimizing the grid traversal logic or using a 1D spatial hash could improve performance.

Code context
            // Check neighbor cells
            for (let r = startRow; r <= endRow; r++) {
                for (let c = startCol; c <= endCol; c++) {
                    const idx = getGridIndex(c, r);
                    if (idx !== -1) {
                        const cell = this.labelGrid[idx];
                        // Brute force check within cell (usually very few items)


Description
The LabelManager class manages 2D labels in 3D space, handling collision detection and culling, but lacks any unit tests.

Location
src/managers/LabelManager.ts:13

Rationale
Requires mocking Three.js components (Camera, CSS2DRenderer) and potentially DOM elements, but the logic is critical for performance and UX.

Code context
export class LabelManager {
    private renderer: CSS2DRenderer;
    private camera: THREE.Camera;
    private labels: CSS2DObject[] = [];

    // Config
    private edgeMargin = 40;

Description
The SceneManager class initializes core Three.js components (Scene, Camera, Renderer) but lacks tests for initialization and cleanup.

Location
src/managers/SceneManager.ts:9

Rationale
Testing requires mocking THREE.WebGLRenderer and checking DOM interactions, which is feasible but requires careful setup.

Code context
export class SceneManager {
    public scene: THREE.Scene;
    public camera: THREE.PerspectiveCamera;
    public renderer: THREE.WebGLRenderer;
    public labelRenderer: CSS2DRenderer;

Description
The `renderList` method clears `innerHTML` and rebuilds the entire list of DOM elements on every update.

Location
src/components/CommandPalette.ts:320

Rationale
Rebuilding the DOM is expensive. Using a virtual list or updating existing nodes would be more performant, especially for large lists.

Code context
    private renderList(): void {
        this.list.innerHTML = '';

        if (this.filteredItems.length === 0) {
            const empty = document.createElement('li');
            empty.className = 'cmd-empty';

Description
The `array.set` method is called for every instance inside the update loop, adding function call overhead.

Location
src/instancing.ts:168

Rationale
While `set` is efficient, calling it thousands of times per frame adds up. Restructuring data to allow bulk updates or reducing calls could help.

Code context
                // Bolt Optimization: Direct buffer access avoids setMatrixAt overhead (function calls + checks)
                // Use TypedArray.set() for optimized bulk copy
                const te = pivot.matrixWorld.elements;
                const offset = index * 16;

                array.set(te, offset);

                needsUpdate = true;

Description
The `config` URL parameter allows loading any JSON file from the same origin. While restricted to the origin, this could expose sensitive JSON files if they are hosted on the server but intended to be private.

Location
src/main.ts:173

Rationale
The code allows loading arbitrary files relative to the origin. The risk depends on the server configuration and content.

Code context
        const urlParams = new URLSearchParams(window.location.search);
        let configUrl = urlParams.get('config') ?? 'system.json';

        // Security check: only allow local files or trusted domains
        try {
            const parsedUrl = new URL(configUrl, window.location.origin);
            if (parsedUrl.origin !== window.location.origin) {
                console.warn('Blocked external config URL:', configUrl);
                configUrl = 'system.json';


HARD
Description
The setupInteraction function orchestrates the entire input system, wiring up UI components and event listeners, but is not unit tested.

Location
src/input.ts:98

Rationale
This function is complex, with many dependencies and side effects (DOM, Three.js events), making it difficult to unit test effectively without extensive mocking or an integration test harness.

Code context
export function setupInteraction(
    context: InteractionContext,
    callbacks: InteractionCallbacks
): InteractionResult {
    // 1. Initialize Base Components (Theme, InfoPanel)
    const { themeManager, infoPanel } = initBaseComponents(callbacks);


Description
The comment suggests using world position instead of local position, which appears to be implemented in the following line.

Location
src/managers/LabelManager.ts:103

Rationale
The code immediately following the comment calls `getWorldPosition`, suggesting the fix is already applied. The comment might be a historical note.

Code context
            if (label.visible && label.element) {
                // Fix: Use World Position, not local position
                label.getWorldPosition(this.tempVec);

                // Frustum Culling